# 相机协议

相机通讯协议用于远程配置机载相机或查询相机的状态。 它支持照片拍摄、视频录制和流媒体预览。 它还提供了查询并配置机载相机存储空间的消息。

> **Tip** 软件 [Dronecode Camera Manager](https://camera-manager.dronecode.org/en/) 实现了该协议。

## 相机连接

相机组件的须按照 [Heartbeat/Connection Protocol](../services/heartbeat.md) 的要求，发送固定频率的心跳包 (一般可取 1Hz)。 每个相机组件都必须独占一个预设的ID：从 [MAV_COMP_ID_CAMERA](../messages/common.md#MAV_COMP_ID_CAMERA) 到 [MAV_COMP_ID_CAMERA6](../messages/common.md#MAV_COMP_ID_CAMERA6)。

当首次检测到一个新相机组件的心跳时，GCS (或其它接收系统) 应立刻启动相机识别程序 [Camera Identification](#camera_identification)。

> **Note** 如果某个相机的心跳中断，接收系统将认为该相机组件已经断开 *disconnected*，并将其从可用相机列表中删除。 如果再次检测到该相机的心跳，必须重新运行一次相机识别程序 *camera identification*。

## 相机基本操作

标志位 [CAMERA_INFORMATION.flags](../messages/common.md#CAMERA_INFORMATION) 提供了相机能力的相关信息。 这些标志位的值来自 [CAMERA_CAP_FLAGS](../messages/common.md#CAMERA_CAP_FLAGS)，GCS 可以从中得知该相机组件是否支持静态照片拍摄、视频录制和流媒体预览，以及拍摄前是否需要切换到特定模式，等等。

### 相机识别 {#camera_identification}

相机识别操作决定了哪些相机是可用/存在的 (然后才能运行其它操作)。

首次接收到一个相机组件的心跳时，GCS会向相机发送一个 [MAV_CMD_REQUEST_CAMERA_INFORMATION](../messages/common.md#MAV_CMD_REQUEST_CAMERA_INFORMATION) 消息。 相机组件随后将响应一个包含结果的 [COMMAND_ACK](../messages/common.md#COMMAND_ACK) 消息。 如果成功 (结果将是 [MAV_RESULT_ACCEPTED](../messages/common.md#MAV_RESULT_ACCEPTED)) 相机组件将继续发送[CAMERA_INFORMATION](../messages/common.md#CAMERA_INFORMATION) 消息。

{% mermaid %} sequenceDiagram; participant GCS participant Camera Camera->>GCS: HEARTBEAT \[cmp id: MAV_COMP_ID_CAMERA\] (first) GCS->>Camera: MAV_CMD_REQUEST_CAMERA_INFORMATION GCS->>GCS: Start timeout Camera->>GCS: COMMAND_ACK Note over Camera,GCS: If MAV_RESULT_ACCEPTED send info. Camera->>GCS: CAMERA_INFORMATION {% endmermaid %}

对相机的操作遵循 [Command Protocol](../services/command.md) 对命令/ACK 的约定 (如果没有收到 `COMMAND_ACK` 响应，`MAV_CMD_REQUEST_CAMERA_INFORMATION` 将会重发几次直到确认失败)。 如果收到 `MAV_RESULT_ACCEPTED` 的ACK之后没有收到 `CAMERA_INFORMATION` 消息，通讯协议将认为该消息丢失，然后重复发送 `MAV_CMD_REQUEST_CAMERA_INFORMATION` 消息的循环。 在轮询3次之后，如果仍未收到 `CAMERA_INFORMATION` 消息，GCS 将认为不支持此相机类型。

`CAMERA_INFORMATION` 消息只包含相机组件支持或不支持特定功能的最简单信息。 这对于基本的图像或视频捕获来说已经足够了。

如果一个相机组件对设置项提供更精细的控制 `CAMERA_INFORMATION.cam_definition_uri` 将包含一个指向相机定义文件 [Camera Definition File](../services/camera_def.md) 的URI。 如果该URI确实存在，GCS将(通过标准的HTTP GET请求) 来获取并解析它，然后启动图形界面以便用户对相机组件进行配置。 相机定义文件可以存放 *hosted* 在任何位置。

> **Note** 如果相机组件提供 HTTP 接口，相机定义文件可以存放在相机上。 否则，它可以存放在任何常规的、可访问的服务器上。

`CAMERA_INFORMATION.cam_definition_version` 字段应提供定义文件的版本信息，允许GCS进行版本比对。 文件一旦被下载，只有当文件版本号改变时才会重新获取。

如果飞行器上安装了多个相机组件，每个相机都要分配一个独一无二的组件ID并发送自己的心跳。 GCS 应根据组件ID为每一个相机组件创建一个单独的相机控制器实例。 所有命令都要指定组件ID并发送给对应的相机组件。

### 相机模式

有些相机组件必须切换到特定模式才能捕获图像或视频。

通过检查 [CAMERA_INFORMATION.flags](../messages/common.md#CAMERA_INFORMATION) 的标志位 [CAMERA_CAP_FLAGS_HAS_MODES](../messages/common.md#CAMERA_CAP_FLAGS_HAS_MODES) 是否为真，GCS就可以确定在发送捕获(图像或视频) 命令之前，是否必须将相机切换到恰当的工作模式。

另外，有些相机允许在任何工作模式下捕获图像，但是分辨率不同。 例如，一台2000万像素的相机可以在`CAMERA_MODE_IMAGE`模式下捕获全分尺寸图像，但是在`CAMERA_MODE_VIDEO`模式下，只能捕获与当前视频分辨率相同的图像。

要查询当前工作模式，GCS向相机发送[MAV_CMD_REQUEST_CAMERA_SETTINGS](../messages/common.md#MAV_CMD_REQUEST_CAMERA_SETTINGS) 命令即可。 相机组件将回复一条 [COMMAND_ACK](../messages/common.md#COMMAND_ACK)消息，该消息有一个 result 字段用来标志查询是否成功。 如果查询成功 (`COMMAND_ACK.result` 字段等于 [MAV_RESULT_ACCEPTED](../messages/common.md#MAV_RESULT_ACCEPTED)) ，相机组件将发送一条 [CAMERA_SETTINGS](../messages/common.md#CAMERA_SETTINGS) 消息。 `CAMERA_SETTINGS.mode_id` 字段就是当前工作模式。

工作流程图如下：

{% mermaid %} sequenceDiagram; participant GCS participant Camera GCS->>Camera: MAV_CMD_REQUEST_CAMERA_SETTINGS GCS->>GCS: Start timeout Camera->>GCS: COMMAND_ACK Note over Camera,GCS: If MAV_RESULT_ACCEPTED send info. Camera->>GCS: CAMERA_SETTINGS {% endmermaid %}

> **Note** 指令ACK 和指令重发的处理方式和相机识别 [camera identification](#camera_identification) 一致 (如果收到标志成功的ACK将等待 `CAMERA_SETTINGS` 消息，重复此循环 - 最多3次 - 直到收到此消息)。

要将相机切换到特定的工作模式，GCS 可以发送一条包含该工作模式的[MAV_CMD_SET_CAMERA_MODE](../messages/common.md#MAV_CMD_SET_CAMERA_MODE) 指令。

工作流程图如下：

{% mermaid %} sequenceDiagram; participant GCS participant Camera GCS->>Camera: MAV_CMD_SET_CAMERA_MODE GCS->>GCS: Start timeout Camera->>GCS: COMMAND_ACK Note over Camera,GCS: If MAV_RESULT_ACCEPTED, mode was changed. {% endmermaid %}

> **Note** 以上操作对指令/Ack的规定遵循 [Command Protocol](../services/command.md) 通用准则。

### 存储状态

在捕获图像和/或视频之前，GCS应该查询相机的存储状态以决定是否还有足够的存储空间(并把当前的存储状态反馈给用户)。 GCS 会发送一条 [MAV_CMD_REQUEST_STORAGE_INFORMATION](../messages/common.md#MAV_CMD_REQUEST_STORAGE_INFORMATION) 命令，并等待相机回复[STORAGE_INFORMATION](../messages/common.md#STORAGE_INFORMATION) 消息。 如果要格式化 (你也可以定义为擦除)，GCS 会发送一条 [MAV_CMD_STORAGE_FORMAT](../messages/common.md#MAV_CMD_STORAGE_FORMAT) 命令。

### 相机捕获状态

除了查询存储器状态，GCS 还要查询当前的 *Camera Capture Status* ，才能为用户提供正确的状态信息。 GCS 会发送一条 [MAV_CMD_REQUEST_CAMERA_CAPTURE_STATUS](../messages/common.md#MAV_CMD_REQUEST_CAMERA_CAPTURE_STATUS) 命令，并等待回复[CAMERA_CAPTURE_STATUS](../messages/common.md#CAMERA_CAPTURE_STATUS) 消息。

### 静态图像捕获

如果[CAMERA_INFORMATION.flags](../messages/common.md#CAMERA_INFORMATION)中的 [CAMERA_CAP_FLAGS_CAPTURE_IMAGE](../messages/common.md#CAMERA_CAP_FLAGS_CAPTURE_IMAGE) 标志位被置位，就说明该相机组件支持静态图像捕获。

GCS通过发送 [MAV_CMD_IMAGE_START_CAPTURE](../messages/common.md#MAV_CMD_IMAGE_START_CAPTURE) 命令来捕获一张图像。 每当捕获到一张图像，相机组件将向GCS发送一条 [CAMERA_IMAGE_CAPTURED](../messages/common.md#CAMERA_IMAGE_CAPTURED) 消息。

`CAMERA_IMAGE_CAPTURED` 消息不仅用来通知GCS图像是否捕获成功，还可用于添加地理位置标签。

捕获命令可用于请求单张的图像捕获或多帧连拍。 如果该命令被设置为多张连拍，GCS可以发送 [MAV_CMD_IMAGE_STOP_CAPTURE](../messages/common.md#MAV_CMD_IMAGE_STOP_CAPTURE) 消息来停止捕获。

### 视频捕获

如果 [CAMERA_INFORMATION.flags](../messages/common.md#CAMERA_INFORMATION) 中的[CAMERA_CAP_FLAGS_CAPTURE_VIDEO](../messages/common.md#CAMERA_CAP_FLAGS_CAPTURE_VIDEO)标志位被置位，则表示该相机组件支持视频捕获。

GCS使用 [MAV_CMD_VIDEO_START_CAPTURE](../messages/common.md#MAV_CMD_VIDEO_START_CAPTURE) 命令来开启视频捕获功能。 收到命令请求后，相机组件将定时向GCS回送 [CAMERA_CAPTURE_STATUS](#camera_capture_status) 消息。

GCS要使用 [MAV_CMD_VIDEO_STOP_CAPTURE](../messages/common.md#MAV_CMD_VIDEO_STOP_CAPTURE) 命令停止视频捕获。

### 流媒体预览

A camera is capable of streaming video if it sets the [CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM](../messages/common.md#CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM) bit set in [CAMERA_INFORMATION.flags](../messages/common.md#CAMERA_INFORMATION).

When the GCS receives the [CAMERA_INFORMATION](../messages/common.md#CAMERA_INFORMATION) message and it detects the [CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM](../messages/common.md#CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM) flag, it will then send the [MAV_CMD_REQUEST_VIDEO_STREAM_INFORMATION](../messages/common.md#MAV_CMD_REQUEST_VIDEO_STREAM_INFORMATION) message to the camera requesting the video streaming configuration. In response, the camera returns a [VIDEO_STREAM_INFORMATION](../messages/common.md#VIDEO_STREAM_INFORMATION) message for each stream it supports.

> **Note** If your camera only provides video streaming and nothing else (no camera features), the [CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM](../messages/common.md#CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM) flag is the only flag you need to set. The GCS will then provide video streaming support and skip camera control.

## Message/Enum Summary



| Message                                                                                                                                 | Description                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                             |
| --------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <span id="mav_cmd_request_camera_information"></span>[MAV_CMD_REQUEST_CAMERA_INFORMATION](../messages/common.md#MAV_CMD_REQUEST_CAMERA_INFORMATION)             | Send command to request [CAMERA_INFORMATION](#camera_information).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                      |
| <span id="camera_information"></span>[CAMERA_INFORMATION](../messages/common.md#CAMERA_INFORMATION)                                                 | Basic information about camera including supported features and URI link to extended information (`cam_definition_uri` field).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| <span id="mav_cmd_request_camera_settings"></span>[MAV_CMD_REQUEST_CAMERA_SETTINGS](../messages/common.md#MAV_CMD_REQUEST_CAMERA_SETTINGS)                   | Send command to request [CAMERA_SETTINGS](#camera_settings).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                            |
| <span id="camera_settings"></span>[CAMERA_SETTINGS](../messages/common.md#CAMERA_SETTINGS)                                                       | Timestamp and camera mode information.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| <span id="mav_cmd_set_camera_mode"></span>[MAV_CMD_SET_CAMERA_MODE](../messages/common.md#MAV_CMD_SET_CAMERA_MODE)                                   | Send command to set [CAMERA_MODE](#camera_mode).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <span id="mav_cmd_request_video_stream_information"></span>[MAV_CMD_REQUEST_VIDEO_STREAM_INFORMATION](../messages/common.md#MAV_CMD_REQUEST_VIDEO_STREAM_INFORMATION) | Send command to request [VIDEO_STREAM_INFORMATION](#video_stream_information). This is sent once for each camera when a camera is detected and it has set the [CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM](../messages/common.md#CAMERA_CAP_FLAGS_HAS_VIDEO_STREAM) flag within the [CAMERA_INFORMATION](../messages/common.md#CAMERA_INFORMATION) message `flags` field.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                  |
| <span id="video_stream_information"></span>[VIDEO_STREAM_INFORMATION](../messages/common.md#VIDEO_STREAM_INFORMATION)                                   | Information defining a video stream configuration. If a camera has more than one video stream, it would send one of this for each video stream, with their specific configuration. Each stream must have its own, unique `stream_id`.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| <span id="mav_cmd_request_video_stream_status"></span>[MAV_CMD_REQUEST_VIDEO_STREAM_STATUS](../messages/common.md#MAV_CMD_REQUEST_VIDEO_STREAM_STATUS)           | Send command to request [VIDEO_STREAM_STATUS](#video_stream_status). This is sent whenever there is a mode change (when [MAV_CMD_SET_CAMERA_MODE](../messages/common.md#MAV_CMD_SET_CAMERA_MODE) is sent.) It allows the camera to update the stream configuration when a camera mode change occurs.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| <span id="video_stream_status"></span>[VIDEO_STREAM_STATUS](../messages/common.md#VIDEO_STREAM_STATUS)                                             | Information updating a video stream configuration. <!-- TBD? -->                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <span id="mav_cmd_request_storage_information"></span>[MAV_CMD_REQUEST_STORAGE_INFORMATION](../messages/common.md#MAV_CMD_REQUEST_STORAGE_INFORMATION)           | Send command to request [STORAGE_INFORMATION](#storage_information).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| <span id="storage_information"></span>[STORAGE_INFORMATION](../messages/common.md#STORAGE_INFORMATION)                                              | Storage information (e.g. number and type of storage devices, total/used/available capacity, read/write speeds).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        |
| <span id="mav_cmd_storage_format"></span>[MAV_CMD_STORAGE_FORMAT](../messages/common.md#MAV_CMD_STORAGE_FORMAT)                                      | Send command to format the specified storage device.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| <span id="mav_cmd_request_camera_capture_status"></span>[MAV_CMD_REQUEST_CAMERA_CAPTURE_STATUS](../messages/common.md#MAV_CMD_REQUEST_CAMERA_CAPTURE_STATUS)      | Send command to request [CAMERA_CAPTURE_STATUS](#camera_capture_status).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              |
| <span id="camera_capture_status"></span>[CAMERA_CAPTURE_STATUS](../messages/common.md#CAMERA_CAPTURE_STATUS)                                        | Camera capture status, including current capture type (if any), capture interval, available capacity.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   |
| <span id="mav_cmd_image_start_capture"></span>[MAV_CMD_IMAGE_START_CAPTURE](../messages/common.md#MAV_CMD_IMAGE_START_CAPTURE)                          | Send command to start image capture, specifying the duration between captures and total number of images to capture.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    |
| <span id="mav_cmd_image_stop_capture"></span>[MAV_CMD_IMAGE_STOP_CAPTURE](../messages/common.md#MAV_CMD_IMAGE_STOP_CAPTURE)                            | Send command to stop image capture.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| <span id="camera_image_captured"></span>[CAMERA_IMAGE_CAPTURED](../messages/common.md#CAMERA_IMAGE_CAPTURED)                                        | Information about image captured (returned to GPS every time an image is captured).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| <span id="mav_cmd_video_start_capture"></span>[MAV_CMD_VIDEO_START_CAPTURE](../messages/common.md#MAV_CMD_VIDEO_START_CAPTURE)                          | Send command to start video capture, specifying the frequency that [CAMERA_CAPTURE_STATUS](#camera_capture_status) messages should be sent while recording.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                           |
| <span id="mav_cmd_video_stop_capture"></span>[MAV_CMD_VIDEO_STOP_CAPTURE](../messages/common.md#MAV_CMD_VIDEO_STOP_CAPTURE)                            | Send command to stop video capture.                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| <span id="camera_image_captured"></span>[CAMERA_IMAGE_CAPTURED](../messages/common.md#CAMERA_IMAGE_CAPTURED)                                        | Information about image captured (returned to GPS every time an image is captured).                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                     |
| <span id="mav_cmd_image_start_streaming"></span>[MAV_CMD_VIDEO_START_STREAMING](../messages/common.md#MAV_CMD_VIDEO_START_STREAMING)                      | Send command to start video streaming for the given Stream ID (`stream_id`.) This is mostly for streaming protocols that *push* a stream. If your camera uses a connection based streaming configuration (RTSP, TCP, etc.), you may ignore it if you don't need it but note that you still must ACK the command, like all `MAV_CMD_XXX` commands. When using a connection based streaming configuration, the GCS will connect the stream from its side. When a camera offers more than one stream and the user switches from one stream to another, the GCS will send a [MAV_CMD_VIDEO_STOP_STREAMING](../messages/common.md#MAV_CMD_VIDEO_STOP_STREAMING) command targeting the current Stream ID followed by a [MAV_CMD_VIDEO_START_STREAMING](../messages/common.md#MAV_CMD_VIDEO_START_STREAMING) targeting the newly selected Stream ID.   |
| <span id="mav_cmd_image_stop_streaming"></span>[MAV_CMD_VIDEO_STOP_STREAMING](../messages/common.md#MAV_CMD_VIDEO_STOP_STREAMING)                        | Send command to stop video streaming for the given Stream ID (`stream_id`.) This is mostly for streaming protocols that *push* a stream. If your camera uses a connection based streaming configuration (RTSP, TCP, etc.), you may ignore it if you don't need it but note that you still must ACK the command, like all `MAV_CMD_XXX` commands. When using a connection based streaming configuration, the GCS will disconnect the stream from its side. When a camera offers more than one stream and the user switches from one stream to another, the GCS will send a [MAV_CMD_VIDEO_STOP_STREAMING](../messages/common.md#MAV_CMD_VIDEO_STOP_STREAMING) command targeting the current Stream ID followed by a [MAV_CMD_VIDEO_START_STREAMING](../messages/common.md#MAV_CMD_VIDEO_START_STREAMING) targeting the newly selected Stream ID. |

| Enum                                                                                             | Description                                                                                                                                                                 |
| ------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| <span id="camera_cap_flags"></span>[CAMERA_CAP_FLAGS](../messages/common.md#CAMERA_CAP_FLAGS)           | Camera capability flags (Bitmap). For example: ability to capture images in video mode, support for survey mode etc. Received in [CAMERA_INFORMATION](#camera_information). |
| <span id="camera_mode"></span>[CAMERA_MODE](../messages/common.md#CAMERA_MODE)                       | Camera mode (image, video, survey etc.). Received in [CAMERA_SETTINGS](#camera_settings).                                                                                   |
| <span id="video_stream_type"></span>[VIDEO_STREAM_TYPE](../messages/common.md#VIDEO_STREAM_TYPE)         | Type of stream - e.g. RTSP, MPEG. Received in [VIDEO_STREAM_INFORMATION ](#video_stream_information).                                                                     |
| <span id="video_stream_status_flags"></span>[VIDEO_STREAM_STATUS_FLAGS](../messages/common.md#VIDEO_STREAM_TYPE) | Bitmap of stream status flags - e.g. zoom, thermal imaging, etc. Received in [VIDEO_STREAM_INFORMATION ](#video_stream_information).                                      |